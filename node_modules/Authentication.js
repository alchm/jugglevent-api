//////////////////
// Authentication
//////////////////

exports.getAuthenticationStrategy = function(provider) {
    var mongoose = provider;
    var User = mongoose.model('User');
    var sha512 = require('sha512-min');

    /*
     usernameAndPassword strategy
     */
    usernameAndPasswordStrategy = function(email, password, done) {
        User.findOne({ email: email }, function (err, user) {
            // LOGS TESTS
            /*console.log('entering strategy');
            console.log('email = ' + email);
            console.log('password = ' + password);
            if (user) { console.log('user found : '); console.log(user); console.log('password? : ' + user.password); }
            if (err) { console.log('user not found'); }*/

            // if error -> callback
            if (err) return done(err);
    
            // if !user -> callback + message
            if (!user) return done(null, false, { message: 'Incorrect username.' });

            // if user -> compare passwords using sha512
            if (user.password != sha512.compute(password)) return done(null, false, { message: 'Incorrect password.' });

            // finally return user
            return done(null, user);
        });
    }

    /*
     Returns strategy
     */
    return usernameAndPasswordStrategy;
}

/*
 Passport.js serializeUser function implementation:
 Stores the authenticated user
 */
exports.serializeUser = function(user, done) {
    //console.log("serializeUser : " + user);
    done(null, user);
};

/*
 Passport.js deserializeUser function implementation:
 Retrieves the previously stored authenticated user
 */
exports.deserializeUser = function(user, done) {
    //console.log("deserializeUser : ");
    //console.log(user);
    done(null, user);
};