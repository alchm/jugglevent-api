if (typeof define !== 'function') {
    var define = require('amdefine')(module);
}
///////////////
// Middlewares
///////////////

var ID = "%s:";

define([
    'Router',
    'lang',
    'express-form'
], function (Router, lang, form) {

    var field = form.field;
    form.configure({
        flashErrors: false,
        autoTrim: true
    });

    exports.locals = function(req, res, next) {
        res.locals.session = req.session;
        res.locals.user = req.user;
        res.locals.message = req.flash();
        next();
    };

    ///////////////////
    // Form validators
    ///////////////////

    // Registration form validator
    exports.registrationFormValidator = form(
        field("firstname")  .is(/^[a-zA-Z]+$/, ID+"Your first name is invalid").required(ID+"What is your first name ?"),
        field("lastname")   .required(ID+"What is your last name ?").is(/^[a-zA-Z]+$/, ID+"Your last name is invalid"),
        field("username")   .is(/^[a-zA-Z]+[.-]?[a-zA-Z]+$/, ID+"Your username must use alphabet characters. You can use \"-\" or \".\" as separator").required(ID+"You must have a username"),
        field("email")      .isEmail(ID+"Your email is invalid").required(ID+"What is your email ?"),
        field("city")       .required(ID+"What is your city ?"),
        field("password")   .required(ID+"Please specify a password").custom(function(value) {
            if (value.length < 6) throw new Error(ID+"Your password length must be greater than 6");
        })
    );

    exports.updateUserFormValidator = form(
        field("firstname")  .is(/^[a-zA-Z]+$/, ID+"Your first name is invalid").required(ID+"What is your first name ?"),
        field("lastname")   .is(/^[a-zA-Z]+$/, ID+"Your last name is invalid").required(ID+"What is your last name ?"),
        field("email")      .isEmail(ID+"Your email is invalid").required(ID+"What is your email?"),
        field("city")       .required(ID+"What is yout city ?")
    );

    exports.loginUserFormValidator = form(
        field("login")      .isEmail(ID+"Your email is invalid")        .required(ID+"What is your login ?"),
        field("password")   .required(ID+"Please specify a password")   .custom(function(value) {
            if (value.length < 6) throw new Error(ID+"Your password is invalid");
        })
    );

    exports.associationRegistrationFormValidator = form(
        field("city")       .required(ID+"What is your city ?"),
        field("school")     .required(ID+"What is your school ?"),
        field("name")       .required(ID+"What is your organisation name ?")    .is(/^[a-zA-Z0-9@$*-_]+$/, ID+"Your organisation name is invalid. Authorized symbols : @$*-_"),
        field("contact")    .required(ID+"What is your contact email ?")        .isEmail(ID+"Your contact email is invalid"),
        field("email")      .required(ID+"What is your user email ?")           .isEmail(ID+"Your email is invalid"),
        field("password")   .required(ID+"What is your user password ?")
    );

    exports.updateUserLangFormValidator = form(
        field("lang").required(ID+"Please select a language")
    );

    return exports;

});


