if (typeof define !== 'function') {
    var define = require('amdefine')(module);
}

define([
    'mongoose',
    'async'
], function (mongoose, async) {

    var exports     = {},
        User        = mongoose.model('User'),
        Association = mongoose.model('Association');

    exports.getById = function (userId, associationId, done) {
        User.findOne({ _id: userId })
            .populate({ path: 'associations',
                        match: { _id: associationId } })
            .exec( function (err, data) {
                if (!err) {
                    if (data) done(null, data);
                    else done(new Error('No result'), null);
                } else done(err, null);
            });
    };

    exports.addById = function (userId, aId, done) {
        async.parallel([
            function (callback) {
                User.findOne({ _id: userId }, 'associations', function (err, user) {
                    if (!err) callback(null, user);
                    else callback(err, null);
                });
            },
            function (callback) {
                Association.findOne({ _id: aId }, '_id', function (err, a) {
                    if (!err) callback(null, a);
                    else callback(err, null);
                });
            }
        ], function (err, results) {
            if (!err) {
                if (results) {
                    var user    = results[0],
                        a       = results[1];
                    user.associations.push( a );
                    user.save( function (err) {
                        if (!err) done(null, true);
                        else done(err, null);
                    });
                } else done(new Error('No result'), null);
            } else done(err, null);
        });
    };

    exports.removeById = function (userId, aId, done) {
        async.parallel([
            function (callback) {
                User.findOne({ _id: userId }, 'associations', function (err, user) {
                    if (!err) callback(null, user);
                    else callback(err, null);
                });
            },
            function (callback) {
                Association.findOne({ _id: aId }, '_id', function (err, a) {
                    if (!err) callback(null, a);
                    else callback(err, null);
                });
            }
        ], function (err, results) {
            if (!err) {
                if (results) {
                    var user    = results[0],
                        a       = results[1];
                } else done(new Error('No result'), null);
            } else done(err, null);
        });
    }

    return exports;

});